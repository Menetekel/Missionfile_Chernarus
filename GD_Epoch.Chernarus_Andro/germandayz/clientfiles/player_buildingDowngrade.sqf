private["_l0","_l1","_l2","_l3","_l4","_l5","_l6","_l7","_l8","_l9","_l10","_l11","_l12","_l13","_l14","_l15","_l16","_l17","_l18","_l19","_l20","_l21","_l22","_l23","_l24","_l25","_l26"];if(TradeInprogress)exitWith{cutText["Downgrade already in progress.","PLAIN DOWN"];};TradeInprogress=true;player removeAction s_player_downgrade_build;s_player_downgrade_build=1;_l16=30;_l17="Plot Pole";_l18=nearestObjects[(vehicle player),["Plastic_Pole_EP1_DZ"],_l16];_l19=[];{if(alive _x)then{_l19 set[(count _l19),_x];};}foreach _l18;_l20=count(_l19);_l12=false;if(_l20==0)then{_l12=true;}else{_l14=_l19 select 0;_l15=_l14 getVariable["CharacterID","0"];if(dayz_playerUID==_l15)then{_l12=true;}else{_l13=player getVariable["friendlyTo",[]];{if((_l15==getPlayerUID _x)&&(isPlayer _x))then{_l15=_x getVariable"CharacterID"};}forEach playableunits;if(_l15 in _l13)then{_l12=true;};};};if(!_l12)exitWith{TradeInprogress=false;cutText[format["Unable to downgrade %1 nearby.",_l17,_l16],"PLAIN DOWN"];};_l9=_this select 3;_l11=_l9 getVariable["CharacterID","0"];if(DZE_Lock_Door!=_l11)exitWith{TradeInprogress=false;cutText["Unable to downgrade you do not know the combination.","PLAIN DOWN"];};_l5=_l9 getVariable["ObjectID","0"];_l6=_l9 getVariable["ObjectUID","0"];if(_l5=="0"&& _l6=="0")exitWith{TradeInprogress=false;s_player_upgrade_build=-1;cutText["Not setup yet.","PLAIN DOWN"];};_l2=typeOf _l9;_l3=getText(configFile>>"CfgVehicles">>_l2>>"displayName");_l10=getArray(configFile>>"CfgVehicles">>_l2>>"downgradeBuilding");if((count _l10)>0)then{_l7=_l10 select 0;_l8=_l10 select 1;player playActionNow"Medic";[player,20,true,(getPosATL player)]spawn player_alertZombies;_l22=false;_l25=false;_l21=0;_l26=[];{_l23=_x select 0;_l24=_x select 1;for"_x"from 1 to _l24 do{_l22=[player,_l23]call BIS_fnc_invAdd;if(!_l22)exitWith{_l25=true;};if(_l22)then{_l21=_l21+1;_l26 set[(count _l26),[_l23,1]];};};if(_l25)exitWith{};}forEach _l8;if(_l21!=0)then{_l0=_l9 getVariable["OEMPos",(getposATL _l9)];_l1=getDir _l9;_l2=_l7;_l4=createVehicle[_l2,[0,0,0],[],0,"CAN_COLLIDE"];_l4 setDir _l1;_l4 setPosATL _l0;if(_l2 in["Plastic_Pole_EP1_DZ","Land_HBarrier3_DZ","Land_HBarrier1_DZ","MetalPanel_DZ","MetalFloor_DZ","CinderWallDoorSmallLocked_DZ","CinderWallDoorLocked_DZ"])then{_l4 addEventHandler["HandleDamage",{false}];_l4 enableSimulation false;};cutText[format["You have downgraded %1.",_l3],"PLAIN DOWN",5];PVDZE_obj_Swap=[_l11,_l4,[_l1,_l0],_l2,_l9,_l5,_l6];publicVariableServer"PVDZE_obj_Swap";player reveal _l4;}else{cutText[format["\n\n%1 of %2 could not be added to your inventory.(not enough room?)",_l21,(getText(configFile>>"CfgMagazines">>_l23>>"displayName"))],"PLAIN DOWN"];{[player,(_x select 0),(_x select 1)]call BIS_fnc_invRemove;}forEach _l26;};}else{cutText["No downgrades available","PLAIN DOWN"];};TradeInprogress=false;s_player_downgrade_build=-1;